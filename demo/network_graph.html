<!---
layout: demo
--->
<html lang="cmn-Hans">
<head>
    <title>关系图谱</title>
    <script src="https://cdn.bootcss.com/d3/5.9.7/d3.js"></script>
    <style>
        main {
            width: 1200px;
            margin: 0 auto;
        }
        #dataset {
            margin-bottom: 20px;
        }
        #dataset textarea {
            width: 1000px;
            height: 50px;
        }
        #root {
            height: 600px;
        }
        #btns {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        svg {
            box-shadow: 0 0 3px 3px #eee;
        }
    </style>
</head>
<body>
    <main>
        <div id="dataset">
            <textarea name="" id="" cols="30" rows="10"></textarea>
            <button id="start">start</button>
        </div>
        <div id="root"></div>
        <div id="btns">
            <button id="add">添加新数据</button>
        </div>
    </main>
    <script>
        const width = 1200;
        const height = 600;
        let dataSorce, svgRoot, svgRootG, simulation,
            graphNode, graphNodeG, graphLink, graphLinkG;
        let nodeDatas = [], linkDatas = [];
        const radius = d3.scaleLinear()
            .domain([0, 500])
            .range([2, 30]);

        const updateNetwork = () => {
            // node
            graphNode = graphNodeG.selectAll('circle')
                .data(nodeDatas, d => d.id);
            graphNode
                .enter()
                .append('circle')
                .attr('r', d => radius(d.value))
                .attr('fill', (d, i) => d3.schemePaired[d.type] || '#000');
            graphNode
                .exit()
                .remove();

            // link
            graphLink = graphLinkG.selectAll('line')
                .data(linkDatas, d => d.id);
            graphLink
                .enter()
                .append('line')
                .attr('stroke', '#666');
            graphLink
                .exit()
                .remove();

            simulation
                .stop()
                .nodes(nodeDatas)
                .alphaTarget(1)
                // .alpha(0.3)
                .restart();
            simulation
                .force('link')
                .links(linkDatas);
        };

        const initNetwork = () => {
            const root = d3.select('#root');

            root.html('');
            
            svgRoot = root.append('svg').attr('width', width).attr('height', height);
            svgRootG = svgRoot.append('g');
            graphNodeG = svgRootG.append('g');
            graphLinkG = svgRootG.append('g');

            simulation = d3.forceSimulation()
                .force("collision", d3.forceCollide(d => radius(d.value)+5))
                // .force("charge", d3.forceManyBody().distanceMax(100))
                .force("charge", d3.forceManyBody())
                // .force('link', d3.forceLink().id(d => d.id).distance(100))
                .force('link', d3.forceLink().id(d => d.id))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("y", d3.forceY(height / 2))
                .force("x", d3.forceX(width/2))
                .on('tick', () => {
                    graphLinkG.selectAll('line')
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    graphNodeG.selectAll('circle')
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                });
                // .force("r", d3.forceRadial(height/2, width/2, height/2).strength(1));
                
            // const drag = simulation => {
            //     function dragstarted(d) {
            //         if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            //         d.fx = d.x;
            //         d.fy = d.y;
            //     }
            //     function dragged(d) {
            //         d.fx = d3.event.x;
            //         d.fy = d3.event.y;
            //     }
            //     function dragended(d) {
            //         if (!d3.event.active) simulation.alphaTarget(0);
            //         d.fx = null;
            //         d.fy = null;
            //     }
            //     return d3.drag()
            //         .on("start", dragstarted)
            //         .on("drag", dragged)
            //         .on("end", dragended);
            // }
            const zoom = d3.zoom()
                .on('zoom', () => {
                    svgRootG.attr("transform", "translate(" + d3.event.transform.x + "," + d3.event.transform.y + ")scale(" + d3.event.transform.k + ")");
                    svgRootG.attr("transform-origin", 'center');
                });

            svgRoot
                .call(zoom);
            
            d3.select('#btns').attr('style', 'display: block');

            // graphNode
            //     .call(drag(forceSimulation));
        };

        const initData = (data) => {
            dataSorce = data;
            dataSorce.nodes.forEach(d => {
                d.value = Math.random() > 0.995 ? 
                    Math.floor(Math.random() * 200 + 300) : 
                    Math.floor(Math.random() * 100 + 0);
            });
        };

        const generateData = () => {
            const tempNode = {};
            const newDatas = dataSorce.nodes.splice(0, 2);

            newDatas.forEach(d => {
                nodeDatas.push(d);
            });

            nodeDatas.forEach(d => {
                tempNode[d.id] = d;
            });

            dataSorce.links.forEach(d => {
                if (tempNode[d.source] && tempNode[d.target]) {
                    linkDatas.push(d);
                }
            });
        };

        const init = (data) => {
            initData(data);
            initNetwork();
            generateData();
            updateNetwork();
        };

        d3.json('./mocks/network.json').then((data) => {
            init(data);
        });

        d3.select('#add').on('click', () => {
            generateData();
            updateNetwork();
        });

        d3.select('#start').on('click', () => {
            const data = d3.select('#dataset textarea').node().value;
            init(JSON.parse(data));
        });
    </script>
</body>
</html>